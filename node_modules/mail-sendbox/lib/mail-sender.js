var nodemailer = require("nodemailer");

var mailSender = function() {

    /**
     * @param {TransportData} transportData
     * @return {Transport}
     */
    this.getTransport = function( transportData ) {
        var _preparedTransportData = {};
        switch (transportData.getHost()) {
            case 'smtp.gmail.com':
                _preparedTransportData = {
                    service: "Gmail",
                    auth: transportData.getAuthParams()
                };
                break;
            default:
                throw new Error('We don\'t support such host');
                break;
        }
        return nodemailer.createTransport("SMTP", _preparedTransportData);
    };

    /**
     * @param {Transport} transport
     * @param {MailData} mailData
     * @param {Function} successCallback
     * @param {Function} errorCallback
     */
    this.sendMail = function(transport, mailData, successCallback, errorCallback) {
        var _self = this;
        transport.sendMail(mailData.getPreparedMailParams(), function(error, response) {
            if (error) {
                _self._callCallback(errorCallback, [error]);
            } else {
                _self._callCallback(successCallback, [response]);
            }
        });
    };

    this._callCallback = function(func, args) {
        if (typeof(func) == "function") {
            func.apply(this, args);
        }
    };

};

/**
 * @param {TransportData} transportData
 * @param {MailData} mailData
 * @param {Function} successCallback
 * @param {Function} errorCallback
 */
module.exports.sendMail = function(transportData, mailData, successCallback, errorCallback) {
    var sender = new mailSender();
    var transport = sender.getTransport( transportData );
    sender.sendMail( transport, mailData, successCallback, errorCallback );
    transport.close();
};